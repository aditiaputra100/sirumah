{% extends 'sirumah/base.html' %}
{% block title %}Cari Rumah{% endblock %}
{% load static %}
{% load currency %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/company_property.css' %}">
{% endblock %}
{% block content %}

<section class="hero-section overflow-visible">
    <div class="container">
        <div class="align-items-center hero-content">
            <h1 class="hero-title">Cari Rumah</h1>
            <p class="hero-subtitle">Temukan rumah impian Anda dengan metode keputusan sesuai preferensi anda</p>
            {% if house_recomendation %}
                <div class="row">
                    <div class="col-12">
                        <h2 class="text-white">Rekomendasi rumah</h2>
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                        Ubah prioritas
                        </button>
                        
                    </div>
                </div>
                <div class="properties-grid">
                    {% for house in house_recomendation %}
                        <div class="property-card position-relative">
                            <!-- Badge Ranking -->
                            <span class="ranking-badge">{{ forloop.counter }}</span>
                            <h5 class="property-title">Perumahaan {{house.real_estate.name}}</h5>
                            <h6 class="property-subtitle">Tipe {{house.house_type}}</h6>
                            <p class="text-muted">{{house.real_estate.village}}, {{house.real_estate.subdistrict}}</p>
                            <p class="property-price">{{house.price|currency}}</p>
                            <div class="property-specs">
                                <div class="spec-item">
                                    <div class="spec-label">Luas Bangunan</div>
                                    <div class="spec-value">{{house.building_area}} m<sup>2</sup></div>
                                </div>
                                <div class="spec-item">
                                    <div class="spec-label">Luas Tanah</div>
                                    <div class="spec-value">{{house.land_area}} m<sup>2</sup></div>
                                </div>
                                {% for attr in house.facility %}
                                    <div class="spec-item">
                                        <div class="spec-label">{{attr.name}}</div>
                                        <div class="spec-value">{{attr.value}}</div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="property-specifications mt-3">
                                <h5 class="mb-2">Spesifikasi</h5>
                                <div class="spec-list">
                                    {% for attr in house.specification %}
                                        <div class="spec-row">
                                            <span class="spec-name">{{attr.name}}</span>
                                            <span class="spec-dot"></span>
                                            <span class="spec-val">{{attr.value}}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
</section>

<section class="find-house-result">
    <div class="container">
        <h2>Daftar perumahaan</h2>
        {% if real_estates %}
            <div class="properties-grid">
                {% for property in real_estates %}
                    <div class="property-card">
                        <div class="property-title">{{property.name}}</div>
                        <div class="property-price">{{property.min_price|currency}} ~ {{property.max_price|currency}}</div>
                        <div class="property-specs">

                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="bi bi-geo-alt"></i> {{property.village}}, {{property.subdistrict}}, {{property.district}}</small>

                        </div>
                        <a class="btn btn-outline-primary" href="{% url 'company_house' company_id=property.company.id real_estate_id=property.id %}">Lihat Detail</a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">Tidak ada data perumahaan tersedia.</p>
        {% endif %}
    </div>
</section>

<!-- Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" id="priorityForm">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">Tentukan prioritas anda</h1>
            <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
          </div>
          <div class="modal-body">
            <p>Pilih prioritas Anda (urutan dicatat sesuai waktu centang):</p>
                {% csrf_token %}
                <ul class="list-group">
                {% for c in criteria %}
                  <li class="list-group-item">
                    <input type="checkbox" 
                           class="priority-checkbox" 
                           value="{{ c.name }}" 
                           id="criteria-{{ c.id }}">
                    <label for="criteria-{{ c.id }}">{{ c.name }}</label>
                    <span class="badge bg-primary float-end order-label" style="display:none;"></span>
                  </li>
                {% endfor %}
              </ul>
              <!-- hidden input untuk kirim ke backend -->
              <input type="hidden" name="priority_order" id="priorityOrder" required>
          </div>
          <div class="modal-footer">
            <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
            <button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    {% if show_modal %}
        var myModal = new bootstrap.Modal(document.getElementById('staticBackdrop'));
        myModal.show();
    {% endif %}


    let order = [];  // simpan urutan pilihan
    const checkboxes = document.querySelectorAll(".priority-checkbox");
    const orderInput = document.getElementById("priorityOrder");

    document.getElementById("priorityForm").addEventListener("submit", function(event) {
    const checked = document.querySelectorAll(".priority-checkbox:checked").length;
    
    if (checked < 1) {
        event.preventDefault(); // cegah submit
        alert("Silakan pilih minimal 1 prioritas!");
    }
    });

    checkboxes.forEach(cb => {
        cb.addEventListener("change", function() {
            const badge = cb.closest("li").querySelector(".order-label");

            if (cb.checked) {
                order.push([cb.id, cb.value]);  // tambahkan ke urutan
                badge.innerText = order.length;
                badge.style.display = "inline-block";
            } else {
                // hapus dari urutan
                order = order.filter(v => v[1] !== cb.value);
                badge.style.display = "none";

                // refresh nomor urut
                let i = 1;
                order.forEach((id, value) => {
                    const li = document.querySelector(`#${id}`).closest("li");
                    li.querySelector(".order-label").innerText = i;
                    i++;
                });
            }

            // simpan ke hidden input
            orderInput.value = JSON.stringify(order.map(v => v[1]));
        });
    });
});
</script>
{% endblock %}
